<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Routine Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        .auth-card h1 { font-size: 28px; margin-bottom: 10px; color: var(--primary); }
        .auth-card p { color: var(--text-sub); margin-bottom: 30px; }
        .auth-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .auth-btn:hover { background: #4338ca; }
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            color: var(--text-sub);
            font-size: 14px;
        }
        .auth-toggle a { color: var(--primary); cursor: pointer; text-decoration: none; }
        .auth-error {
            background: #fee2e2;
            color: var(--danger);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        /* Main App */
        .app-container { display: none; width: 100%; }
        .app-container.active { display: flex; }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--card);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.03);
            flex-shrink: 0;
        }

        .sidebar-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h1 { font-size: 18px; color: var(--primary); font-weight: 800; }
        .sidebar-header p { font-size: 12px; color: var(--text-sub); }
        .logout-btn {
            padding: 6px 12px;
            background: #fee2e2;
            color: var(--danger);
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }

        .stat-card {
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .stat-card h3 { font-size: 11px; text-transform: uppercase; color: var(--text-sub); margin-bottom: 4px; }
        .stat-card .val { font-size: 15px; font-weight: 700; display: block; }

        .chart-container { height: 160px; margin-bottom: 20px; }
        .chart-label { font-size: 12px; font-weight: 700; color: var(--text-sub); text-align: center; display: block; margin-bottom: 5px; }

        /* Main Content */
        .main-content { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        .table-section {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid #f1f5f9;
        }

        .section-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            justify-content: space-between;
        }
        .section-title::before { content: ''; width: 4px; height: 14px; background: var(--primary); border-radius: 2px; }
        
        .add-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }
        .add-btn:hover { background: #4338ca; }

        /* Table */
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8fafc; color: var(--text-sub); font-weight: 600; padding: 6px 2px; border: 1px solid #f1f5f9; }
        td { padding: 4px 1px; border: 1px solid #f1f5f9; text-align: center; }
        
        .habit-col { text-align: left !important; padding-left: 10px; font-weight: 600; min-width: 180px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .stats-col { font-weight: 700; color: var(--primary); width: 35px; }
        .day-col { width: 30px; }
        .actions-col { width: 60px; }

        .master-row { background: #eef2ff !important; font-size: 10px; }

        /* Checkboxes */
        input[type="checkbox"] {
            appearance: none; width: 15px; height: 15px; border: 1.5px solid #cbd5e1; border-radius: 3px;
            cursor: pointer; transition: 0.2s; position: relative; vertical-align: middle;
        }
        input[type="checkbox"]:checked { background-color: var(--success); border-color: var(--success); }
        input[type="checkbox"]:checked::after {
            content: '✓'; position: absolute; color: white; font-size: 10px; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .master-cb:checked { background-color: var(--primary) !important; border-color: var(--primary) !important; }

        /* Action Buttons */
        .action-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            margin: 0 2px;
        }
        .edit-btn { background: #dbeafe; color: #1e40af; }
        .delete-btn { background: #fee2e2; color: #991b1b; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h2 { margin-bottom: 15px; font-size: 18px; }
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .modal-btn-primary { background: var(--primary); color: white; }
        .modal-btn-secondary { background: #e2e8f0; color: var(--text-main); }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-sub);
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <h1>Elite Routine Tracker</h1>
            <p id="authSubtitle">Sign in to sync across all your devices</p>
            <div id="authError" class="auth-error" style="display: none;"></div>
            
            <form id="authForm">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
                <button type="submit" class="auth-btn" id="authSubmitBtn">Sign In</button>
            </form>
            
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a id="authToggleLink">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div>
                    <h1>Elite Routine</h1>
                    <p id="monthYear">January 2026</p>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="stat-group">
                <div class="stat-card" style="border-left: 4px solid var(--success);">
                    <h3>Monthly Score</h3>
                    <div class="val" id="overallVal">0%</div>
                </div>

                <div class="stat-card" style="border-left: 4px solid var(--primary);">
                    <h3>Best Habit</h3>
                    <div class="val" id="bestName" style="font-size: 13px;">-</div>
                    <div class="sub-text" id="bestScore"></div>
                </div>

                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <h3>Needs Focus</h3>
                    <div class="val" id="worstName" style="font-size: 13px; color: var(--danger);">-</div>
                    <div class="sub-text" id="worstScore"></div>
                </div>
            </div>

            <div class="chart-section">
                <span class="chart-label">Performance Trend</span>
                <div class="chart-container"><canvas id="lineChart"></canvas></div>
            </div>

            <div class="chart-section">
                <span class="chart-label">Completion Ratio</span>
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>

            <div class="chart-section">
                <span class="chart-label">Top 5 Best Habits</span>
                <div class="chart-container"><canvas id="bestChart"></canvas></div>
            </div>

            <div class="chart-section">
                <span class="chart-label">Top 5 Habits to Focus</span>
                <div class="chart-container"><canvas id="worstChart"></canvas></div>
            </div>
        </aside>

        <main class="main-content">
            <section class="table-section">
                <div class="section-title">
                    <span>Daily Tracker (30 Days Full View)</span>
                    <button class="add-btn" onclick="openHabitModal()">+ Add Habit</button>
                </div>
                <div class="loading" id="dailyLoading">Loading habits...</div>
                <div class="table-wrapper" id="dailyTableWrapper" style="display: none;">
                    <table>
                        <thead>
                            <tr id="dailyHeader">
                                <th class="habit-col">Activity</th>
                                <th class="stats-col">Done</th>
                                <th class="stats-col">%</th>
                            </tr>
                            <tr id="masterRow" class="master-row">
                                <td class="habit-col">SET ALL FOR DAY →</td>
                                <td class="stats-col"></td><td class="stats-col"></td>
                            </tr>
                        </thead>
                        <tbody id="dailyBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Habit Modal -->
    <div class="modal" id="habitModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add New Habit</h2>
            <input type="text" class="modal-input" id="habitName" placeholder="Habit name (e.g., Meditate 5-10m)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeHabitModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveHabit()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const SUPABASE_URL = 'https://ngxzaywoelxukmrvbhux.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5neHpheXdvZWx4dWttcnZiaHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NjYwNzgsImV4cCI6MjA4NDA0MjA3OH0.3FRygU5-ftjM7ZKnZTqdB4d8q4_D8NZCG8nGWlKrQYw';

        // Initialize Supabase
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============ GLOBAL STATE ============
        let currentUser = null;
        let habits = [];
        let completions = {};
        let charts = {};
        let editingHabitId = null;
        const daysInMonth = 30;

        // ============ AUTH FUNCTIONS ============
                    let isSignUp = false;

            // Helper: Consistent YYYY-MM-DD local date string
            function getLocalDateString(day) {
                const now = new Date();
                const date = new Date(now.getFullYear(), now.getMonth(), day);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const dayStr = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${dayStr}`;
            }

        document.getElementById('authToggleLink').addEventListener('click', () => {
            isSignUp = !isSignUp;
            if (isSignUp) {
                document.getElementById('authSubtitle').textContent = 'Create your account';
                document.getElementById('authSubmitBtn').textContent = 'Sign Up';
                document.getElementById('authToggleText').textContent = 'Already have an account?';
                document.getElementById('authToggleLink').textContent = 'Sign In';
            } else {
                document.getElementById('authSubtitle').textContent = 'Sign in to sync across all your devices';
                document.getElementById('authSubmitBtn').textContent = 'Sign In';
                document.getElementById('authToggleText').textContent = "Don't have an account?";
                document.getElementById('authToggleLink').textContent = 'Sign Up';
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorDiv = document.getElementById('authError');

            try {
                let result;
                if (isSignUp) {
                    result = await supabaseClient.auth.signUp({ email, password });
                    if (result.error) throw result.error;
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d1fae5';
                    errorDiv.style.color = '#065f46';
                    errorDiv.textContent = 'Account created! Check your email to verify.';
                } else {
                    result = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (result.error) throw result.error;
                    await initApp();
                }
            } catch (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = error.message;
            }
        });

        async function logout() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        // Check if user is logged in
        let authListenerSet = false;
        
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session && !authListenerSet) {
                authListenerSet = true;
                currentUser = session.user;
                initApp();
            }
        });

        // ============ APP INITIALIZATION ============
        let isInitialized = false;

        async function initApp() {
            if (isInitialized) return; // Prevent multiple initializations
            isInitialized = true;

            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Set current month/year
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('monthYear').textContent = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;

            // Build day headers ONLY ONCE
            const header = document.getElementById('dailyHeader');
            const masterRow = document.getElementById('masterRow');
            
            // Clear existing day columns first (in case of re-initialization)
            while (header.children.length > 3) {
                header.removeChild(header.lastChild);
            }
            while (masterRow.children.length > 3) {
                masterRow.removeChild(masterRow.lastChild);
            }
            
            for (let d = 1; d <= daysInMonth; d++) {
                const th = document.createElement('th');
                th.textContent = d;
                th.className = 'day-col';
                header.appendChild(th);

                const td = document.createElement('td');
                td.innerHTML = `<input type="checkbox" class="master-cb" onchange="toggleColumn(${d}, this.checked)">`;
                masterRow.appendChild(td);
            }

            // Add actions column
            const actionsHeader = document.createElement('th');
            actionsHeader.textContent = 'Actions';
            actionsHeader.className = 'actions-col';
            header.appendChild(actionsHeader);
            
            const actionsCell = document.createElement('td');
            masterRow.appendChild(actionsCell);

            await loadHabits();
            await loadCompletions();
            render();
        }

        // ============ DATABASE FUNCTIONS ============
        async function loadHabits() {
            try {
                const { data, error } = await supabaseClient
                    .from('habits')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('is_active', true)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                habits = data || [];
            } catch (error) {
                console.error('Error loading habits:', error);
            }
        }

        async function loadCompletions() {
            try {
                const { data, error } = await supabaseClient
                    .from('habit_completions')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) throw error;
                
                completions = {};
                (data || []).forEach(comp => {
                    const date = new Date(comp.completion_date);
                    const day = date.getDate();
                    completions[`${comp.habit_id}-${day}`] = true;
                });
            } catch (error) {
                console.error('Error loading completions:', error);
            }
        }

        async function toggleCell(habitId, day) {
            const key = `${habitId}-${day}`;
            const isChecked = !completions[key];
            
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const completionDate = new Date(year, month, day);
                const dateStr = completionDate.toISOString().split('T')[0];

                if (isChecked) {
                    const { error } = await supabaseClient
                        .from('habit_completions')
                        .upsert({
                            habit_id: habitId,
                            user_id: currentUser.id,
                            completion_date: dateStr
                        }, {
                            onConflict: 'habit_id,completion_date'
                        });
                    if (error && error.code !== '23505') throw error;
                    completions[key] = true;
                } else {
                    const { error } = await supabaseClient
                        .from('habit_completions')
                        .delete()
                        .eq('habit_id', habitId)
                        .eq('user_id', currentUser.id)
                        .eq('completion_date', dateStr);
                    if (error) throw error;
                    delete completions[key];
                }
                
                render();
            } catch (error) {
                console.error('Error toggling completion:', error);
                alert('Error: ' + error.message);
            }
        }

        async function toggleColumn(day, checked) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const completionDate = new Date(year, month, day);
            const dateStr = completionDate.toISOString().split('T')[0];

            try {
                if (checked) {
                    const inserts = habits.map(h => ({
                        habit_id: h.id,
                        user_id: currentUser.id,
                        completion_date: dateStr
                    }));
                    
                    const { error } = await supabaseClient
                        .from('habit_completions')
                        .upsert(inserts, { onConflict: 'habit_id,completion_date' });
                    
                    if (error) throw error;
                    habits.forEach(h => completions[`${h.id}-${day}`] = true);
                } else {
                    const habitIds = habits.map(h => h.id);
                    const { error } = await supabaseClient
                        .from('habit_completions')
                        .delete()
                        .in('habit_id', habitIds)
                        .eq('completion_date', dateStr);
                    
                    if (error) throw error;
                    habits.forEach(h => delete completions[`${h.id}-${day}`]);
                }
                
                render();
            } catch (error) {
                console.error('Error toggling column:', error);
            }
        }

        // ============ HABIT MODAL ============
        function openHabitModal(habitId = null) {
            editingHabitId = habitId;
            const modal = document.getElementById('habitModal');
            const title = document.getElementById('modalTitle');
            const input = document.getElementById('habitName');

            if (habitId) {
                const habit = habits.find(h => h.id === habitId);
                title.textContent = 'Edit Habit';
                input.value = habit.name;
            } else {
                title.textContent = 'Add New Habit';
                input.value = '';
            }

            modal.classList.add('active');
        }

        function closeHabitModal() {
            document.getElementById('habitModal').classList.remove('active');
            editingHabitId = null;
        }

        async function saveHabit() {
            const name = document.getElementById('habitName').value.trim();
            if (!name) return;

            try {
                if (editingHabitId) {
                    const { error } = await supabaseClient
                        .from('habits')
                        .update({ name, updated_at: new Date().toISOString() })
                        .eq('id', editingHabitId);
                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('habits')
                        .insert({
                            user_id: currentUser.id,
                            name,
                            frequency: 'daily',
                            color: '#3B82F6'
                        });
                    if (error) throw error;
                }

                await loadHabits();
                render();
                closeHabitModal();
            } catch (error) {
                console.error('Error saving habit:', error);
                alert('Error saving habit: ' + error.message);
            }
        }

        async function deleteHabit(habitId) {
            if (!confirm('Delete this habit? This will remove all completion data.')) return;

            try {
                const { error } = await supabaseClient
                    .from('habits')
                    .update({ is_active: false })
                    .eq('id', habitId);

                if (error) throw error;

                await loadHabits();
                render();
            } catch (error) {
                console.error('Error deleting habit:', error);
            }
        }

        // ============ RENDER FUNCTIONS ============
        function render() {
            document.getElementById('dailyLoading').style.display = 'none';
            document.getElementById('dailyTableWrapper').style.display = 'block';

            const dailyBody = document.getElementById('dailyBody');
            dailyBody.innerHTML = '';

            habits.forEach(habit => {
                const habitCreatedDate = new Date(habit.created_at);
                const habitCreatedDay = habitCreatedDate.getDate();
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const habitMonth = habitCreatedDate.getMonth();
                const habitYear = habitCreatedDate.getFullYear();
                
                // Only count days from when habit was created in current month
                const isCurrentMonth = habitYear === currentYear && habitMonth === currentMonth;
                const startDay = isCurrentMonth ? habitCreatedDay : 1;
                const validDays = daysInMonth - startDay + 1;

                let done = 0;
                for (let d = startDay; d <= daysInMonth; d++) {
                    if (completions[`${habit.id}-${d}`]) done++;
                }
                
                const pct = validDays > 0 ? Math.round((done / validDays) * 100) : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="habit-col">${habit.name}</td>
                    <td class="stats-col">${done}</td>
                    <td class="stats-col">${pct}%</td>
                `;

                for (let d = 1; d <= daysInMonth; d++) {
                    const td = document.createElement('td');
                    // Disable checkboxes for days before habit was created
                    if (isCurrentMonth && d < habitCreatedDay) {
                        td.innerHTML = '<input type="checkbox" disabled style="opacity: 0.2;">';
                    } else {
                        const checked = completions[`${habit.id}-${d}`] ? 'checked' : '';
                        td.innerHTML = `<input type="checkbox" ${checked} onchange="toggleCell('${habit.id}', ${d})">`;
                    }
                    tr.appendChild(td);
                }

                const actionsTd = document.createElement('td');
                actionsTd.className = 'actions-col';
                actionsTd.innerHTML = `
                    <button class="action-btn edit-btn" onclick="openHabitModal('${habit.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteHabit('${habit.id}')">Del</button>
                `;
                tr.appendChild(actionsTd);

                dailyBody.appendChild(tr);
            });

            updateAnalytics();
        }

        function updateAnalytics() {
            const stats = habits.map(habit => {
                const habitCreatedDate = new Date(habit.created_at);
                const habitCreatedDay = habitCreatedDate.getDate();
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const habitMonth = habitCreatedDate.getMonth();
                const habitYear = habitCreatedDate.getFullYear();
                
                const isCurrentMonth = habitYear === currentYear && habitMonth === currentMonth;
                const startDay = isCurrentMonth ? habitCreatedDay : 1;
                const validDays = daysInMonth - startDay + 1;

                let count = 0;
                for (let d = startDay; d <= daysInMonth; d++) {
                    if (completions[`${habit.id}-${d}`]) count++;
                }
                
                const pct = validDays > 0 ? Math.round((count / validDays) * 100) : 0;
                return { name: habit.name, count, pct, validDays };
            });

            if (stats.length === 0) {
                document.getElementById('overallVal').textContent = '0%';
                document.getElementById('bestName').textContent = 'No habits yet';
                document.getElementById('worstName').textContent = 'Add habits to start';
                return;
            }

            const totalDone = stats.reduce((sum, s) => sum + s.count, 0);
            const totalPossible = stats.reduce((sum, s) => sum + s.validDays, 0);
            const overallPct = totalPossible > 0 ? ((totalDone / totalPossible) * 100).toFixed(1) : 0;

            document.getElementById('overallVal').textContent = overallPct + '%';

            const sortedStats = [...stats].sort((a, b) => b.pct - a.pct);
            const best = sortedStats[0];
            const worst = sortedStats[sortedStats.length - 1];

            document.getElementById('bestName').textContent = best.name;
            document.getElementById('bestScore').textContent = `${best.pct}% complete`;
            document.getElementById('worstName').textContent = worst.name;
            document.getElementById('worstScore').textContent = `${worst.pct}% complete`;

            // Line Chart - Daily Performance
            const dailyPerformance = Array.from({length: daysInMonth}, (_, i) => {
                const day = i + 1;
                const dayHabits = habits.filter(h => {
                    const createdDay = new Date(h.created_at).getDate();
                    const createdMonth = new Date(h.created_at).getMonth();
                    const createdYear = new Date(h.created_at).getFullYear();
                    const now = new Date();
                    return !(createdYear === now.getFullYear() && createdMonth === now.getMonth() && day < createdDay);
                });
                const completed = dayHabits.filter(h => completions[`${h.id}-${day}`]).length;
                return dayHabits.length > 0 ? (completed / dayHabits.length) * 100 : 0;
            });

            if (charts.lineChart) charts.lineChart.destroy();
            charts.lineChart = new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: Array.from({length: daysInMonth}, (_, i) => i + 1),
                    datasets: [{
                        data: dailyPerformance,
                        borderColor: '#4f46e5',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(79, 70, 229, 0.05)',
                        pointRadius: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 0, max: 100, ticks: { callback: v => v + '%' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Pie Chart - Overall Completion
            if (charts.pieChart) charts.pieChart.destroy();
            charts.pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Done', 'Left'],
                    datasets: [{
                        data: [totalDone, totalPossible - totalDone],
                        backgroundColor: ['#10b981', '#f1f5f9'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Best Habits Chart
            const top5Best = sortedStats.slice(0, 5);
            if (charts.bestChart) charts.bestChart.destroy();
            charts.bestChart = new Chart(document.getElementById('bestChart'), {
                type: 'bar',
                data: {
                    labels: top5Best.map(s => s.name.length > 15 ? s.name.substring(0, 15) + '...' : s.name),
                    datasets: [{
                        data: top5Best.map(s => s.pct),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: 0, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });

            // Worst Habits Chart
            const top5Worst = [...sortedStats].reverse().slice(0, 5);
            if (charts.worstChart) charts.worstChart.destroy();
            charts.worstChart = new Chart(document.getElementById('worstChart'), {
                type: 'bar',
                data: {
                    labels: top5Worst.map(s => s.name.length > 15 ? s.name.substring(0, 15) + '...' : s.name),
                    datasets: [{
                        data: top5Worst.map(s => s.pct),
                        backgroundColor: '#ef4444',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: 0, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });
        }

        // Check auth on load
        (async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                await initApp();
            }
        })();
    </script>
</body>
</html>
